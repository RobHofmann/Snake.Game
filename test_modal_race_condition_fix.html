<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Race Condition Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #console { background: #000; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Snake Game - Modal Race Condition Fix Test</h1>
    
    <div class="info">
        <strong>Test Objective:</strong> Verify that the high score modal appears when achieving a score >= 300 
        after fixing the race condition where flags were reset before modal validation could complete.
    </div>
    
    <div class="info">
        <strong>Key Fix:</strong> Added 100ms delay to flag reset in updateUI() function to prevent immediate 
        reset of gameStartTime and gameWasPlayed flags during Ready state transitions.
    </div>
    
    <button onclick="simulateGameWithHighScore()">Simulate Game with Score 300</button>
    <button onclick="simulateGameWithLowScore()">Simulate Game with Score 50</button>
    <button onclick="clearConsole()">Clear Console</button>
    
    <div id="console"></div>

    <script>
        const consoleDiv = document.getElementById('console');
        
        // Mock variables to simulate the game state
        let gameState = 'Ready';
        let score = 0;
        let gameStartTime = 0;
        let gameWasPlayed = false;
        let scoreSubmitted = false;
        let pageLoadTime = Date.now();
        
        function log(message) {
            consoleDiv.innerHTML += message + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        // Mock the key functions from the game
        function updateUI() {
            log(`🔄 updateUI called - gameState: ${gameState}`);
            
            if (gameState === 'Ready') {
                if (!window.readyStateActive) {
                    log('🔄 CONSECUTIVE MODAL DEBUG: First time entering Ready state - scheduling delayed flag reset...');
                    log(`   Before reset - scoreSubmitted: ${scoreSubmitted}, gameStartTime: ${gameStartTime}, gameWasPlayed: ${gameWasPlayed}`);
                    
                    // Reset scoreSubmitted immediately as this is safe
                    scoreSubmitted = false;
                    
                    // Delay resetting gameStartTime and gameWasPlayed to allow modal validation to complete
                    setTimeout(() => {
                        log('🔄 CONSECUTIVE MODAL DEBUG: Executing delayed flag reset...');
                        log(`   Before delayed reset - gameStartTime: ${gameStartTime}, gameWasPlayed: ${gameWasPlayed}`);
                        
                        gameStartTime = 0; // Reset game start time
                        gameWasPlayed = false; // Reset game played flag
                        
                        log(`   After delayed reset - gameStartTime: ${gameStartTime}, gameWasPlayed: ${gameWasPlayed}`);
                    }, 100); // 100ms delay should be enough for modal validation to complete
                    
                    log(`   After immediate reset - scoreSubmitted: ${scoreSubmitted} (gameStartTime and gameWasPlayed will reset in 100ms)`);
                    
                    // Mark that we're now in Ready state to prevent repeated resets
                    window.readyStateActive = true;
                } else {
                    log('🔄 CONSECUTIVE MODAL DEBUG: Already in Ready state - skipping flag reset');
                }
            } else if (gameState === 'GameOver') {
                // Clear Ready state flag since we're leaving Ready state
                window.readyStateActive = false;
                
                log('🔍 CONSECUTIVE MODAL DEBUG: Checking modal conditions...');
                log(`   scoreSubmitted: ${scoreSubmitted} (should be false)`);
                log(`   gameStartTime: ${gameStartTime} (should be > 0)`);
                log(`   score: ${score} (should be > 0)`);
                log(`   gameWasPlayed: ${gameWasPlayed} (should be true)`);
                
                // Call checkForHighScore immediately during GameOver
                setTimeout(() => checkForHighScore(), 10);
            }
        }
        
        function checkForHighScore() {
            log('🎯 checkForHighScore called');
            log(`   Current flags - gameStartTime: ${gameStartTime}, gameWasPlayed: ${gameWasPlayed}, score: ${score}`);
            
            // Basic validation - only check essential conditions
            const timeSincePageLoad = Date.now() - pageLoadTime;
            
            // Only block for first 500ms to prevent page load issues
            if (timeSincePageLoad < 500) {
                log('🚫 Too soon after page load, submitting as Anonymous');
                submitScore('Anonymous');
                return;
            }
            
            // Don't show modal for zero/negative scores
            if (score <= 0) {
                log('🚫 Score is 0 or negative, submitting as Anonymous');
                submitScore('Anonymous');
                return;
            }
            
            // Don't show modal if no actual game was played
            if (!gameWasPlayed || !gameStartTime) {
                log('🚫 No real game played, submitting as Anonymous');
                log(`   gameWasPlayed: ${gameWasPlayed}, gameStartTime: ${gameStartTime}`);
                submitScore('Anonymous');
                return;
            }
            
            log('✅ All conditions met, showing name input modal for score: ' + score);
            showNameInputModal();
        }
        
        function submitScore(playerName) {
            log(`📝 submitScore called with playerName: ${playerName}`);
            scoreSubmitted = true;
            // This would typically reset game state to 'Ready'
            gameState = 'Ready';
            updateUI();
        }
        
        function showNameInputModal() {
            log('🎉 HIGH SCORE MODAL SHOWN! The fix worked!');
            log('🏆 Player can now enter their name for the leaderboard');
        }
        
        function startGame() {
            log('🎮 Starting new game...');
            gameState = 'Playing';
            gameStartTime = Date.now();
            gameWasPlayed = true;
            scoreSubmitted = false;
            window.readyStateActive = false;
            
            log(`   Flags set - gameStartTime: ${gameStartTime}, gameWasPlayed: ${gameWasPlayed}`);
        }
        
        function endGame(finalScore) {
            log(`🎯 Game ended with score: ${finalScore}`);
            score = finalScore;
            gameState = 'GameOver';
            updateUI();
        }
        
        function simulateGameWithHighScore() {
            log('\n=== SIMULATING GAME WITH HIGH SCORE (300) ===');
            clearFlags();
            startGame();
            setTimeout(() => endGame(300), 50);
        }
        
        function simulateGameWithLowScore() {
            log('\n=== SIMULATING GAME WITH LOW SCORE (50) ===');
            clearFlags();
            startGame();
            setTimeout(() => endGame(50), 50);
        }
        
        function clearFlags() {
            gameStartTime = 0;
            gameWasPlayed = false;
            scoreSubmitted = false;
            gameState = 'Ready';
            window.readyStateActive = false;
        }
        
        log('🚀 Test environment ready. Click buttons above to test the modal fix.');
        log('Expected behavior: Score >= 300 should show modal, lower scores should auto-submit as Anonymous.');
    </script>
</body>
</html>
