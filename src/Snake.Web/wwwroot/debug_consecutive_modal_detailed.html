<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Consecutive Modal - Detailed Analysis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .test-button {
            background: linear-gradient(45deg, #4DEE5A, #39ff14);
            border: none;
            color: black;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 238, 20, 0.4);
        }
        
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #333;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .status.success { border-color: #4DEE5A; background: rgba(77, 238, 90, 0.1); }
        .status.error { border-color: #ff3131; background: rgba(255, 49, 49, 0.1); }
        .status.info { border-color: #4DEEA6; background: rgba(77, 238, 166, 0.1); }
        
        .game-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #4DEE5A;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .debug-panel {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #444;
        }
        
        .flag-status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .flag-true { background: #0a5c0a; color: #4DEE5A; }
        .flag-false { background: #5c0a0a; color: #ff6666; }
        .flag-number { background: #0a0a5c; color: #6666ff; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üî¨ Consecutive Modal Debug - Detailed Analysis</h1>
        
        <div class="status info">
            <strong>This test performs deep analysis of the consecutive modal issue.</strong><br>
            It will show detailed logging and flag states for each step.
        </div>
        
        <div style="margin: 20px 0;">
            <button class="test-button" onclick="loadGame()">üéÆ Load Game</button>
            <button class="test-button" onclick="testSingleModal()">üß™ Test Single Modal</button>
            <button class="test-button" onclick="testConsecutiveModals()">üîÑ Test Consecutive Modals</button>
            <button class="test-button" onclick="analyzePageLoadTiming()">‚è∞ Analyze Page Load Timing</button>
            <button class="test-button" onclick="clearConsole()">üßπ Clear Console</button>
        </div>
        
        <div id="status-display"></div>
        
        <iframe id="game-frame" class="game-frame" style="display: none;"></iframe>
        
        <div class="debug-panel">
            <h3>üö© Current Game Flags:</h3>
            <div id="flag-display">Not loaded yet</div>
        </div>
        
        <div class="console-output" id="console-output"></div>
    </div>

    <script>
        let gameWindow = null;
        let statusDiv = document.getElementById('status-display');
        let consoleDiv = document.getElementById('console-output');
        let flagDiv = document.getElementById('flag-display');

        function updateStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        function clearConsole() {
            consoleDiv.innerHTML = '';
        }

        function updateFlags() {
            if (!gameWindow) {
                flagDiv.innerHTML = 'Game not loaded';
                return;
            }

            try {
                const flags = {
                    gameState: gameWindow.gameState,
                    score: gameWindow.score,
                    gameStartTime: gameWindow.gameStartTime,
                    gameWasPlayed: gameWindow.gameWasPlayed,
                    scoreSubmitted: gameWindow.scoreSubmitted,
                    pageLoadTime: gameWindow.pageLoadTime
                };

                let html = '';
                for (const [key, value] of Object.entries(flags)) {
                    let className = 'flag-number';
                    if (typeof value === 'boolean') {
                        className = value ? 'flag-true' : 'flag-false';
                    }
                    html += `<span class="flag-status ${className}">${key}: ${value}</span>`;
                }

                // Add timing calculations
                if (gameWindow.pageLoadTime) {
                    const timeSincePageLoad = Date.now() - gameWindow.pageLoadTime;
                    html += `<br><span class="flag-status flag-number">timeSincePageLoad: ${timeSincePageLoad}ms</span>`;
                }
                
                if (gameWindow.gameStartTime > 0) {
                    const timeSinceGameStart = Date.now() - gameWindow.gameStartTime;
                    html += `<span class="flag-status flag-number">timeSinceGameStart: ${timeSinceGameStart}ms</span>`;
                }

                flagDiv.innerHTML = html;
            } catch (error) {
                flagDiv.innerHTML = `Error reading flags: ${error.message}`;
            }
        }

        function loadGame() {
            log('üéÆ Loading Snake game...');
            updateStatus('Loading game...', 'info');
            
            const iframe = document.getElementById('game-frame');
            iframe.style.display = 'block';
            iframe.src = 'index.html';
            
            iframe.onload = function() {
                gameWindow = iframe.contentWindow;
                log('‚úÖ Game loaded successfully');
                updateStatus('Game loaded! Waiting 3 seconds for initialization...', 'success');
                
                // Wait for game to fully initialize
                setTimeout(() => {
                    updateFlags();
                    log('üîÑ Game initialization complete');
                    updateStatus('Game ready for testing', 'success');
                    
                    // Start monitoring flags
                    setInterval(updateFlags, 1000);
                }, 3000);
            };
            
            iframe.onerror = function() {
                log('‚ùå Failed to load game');
                updateStatus('Failed to load game', 'error');
            };
        }

        function analyzePageLoadTiming() {
            if (!gameWindow) {
                updateStatus('Game not loaded yet!', 'error');
                return;
            }

            log('‚è∞ ANALYZING PAGE LOAD TIMING:');
            
            const now = Date.now();
            const pageLoadTime = gameWindow.pageLoadTime;
            const timeSincePageLoad = now - pageLoadTime;
            
            log(`   - Current time: ${now}`);
            log(`   - Page load time: ${pageLoadTime}`);
            log(`   - Time since page load: ${timeSincePageLoad}ms`);
            log(`   - Grace period (2000ms): ${timeSincePageLoad >= 2000 ? 'PASSED' : 'BLOCKED'}`);
            
            if (timeSincePageLoad < 2000) {
                log(`   ‚ö†Ô∏è WARNING: Still in grace period! Modal will be blocked.`);
                log(`   ‚è≥ Need to wait ${2000 - timeSincePageLoad}ms more`);
            } else {
                log(`   ‚úÖ Grace period passed, modal should be allowed`);
            }
        }

        function testSingleModal() {
            if (!gameWindow) {
                updateStatus('Game not loaded yet!', 'error');
                return;
            }

            log('\nüß™ TESTING SINGLE MODAL:');
            updateStatus('Testing single modal...', 'info');

            try {
                // Check timing first
                analyzePageLoadTiming();
                
                log('üîß Setting up test conditions...');
                
                // Reset to Ready state first
                gameWindow.gameState = 'Ready';
                gameWindow.updateUI();
                updateFlags();
                
                log('1Ô∏è‚É£ Reset to Ready state');
                
                // Set up game conditions manually to bypass timing issues
                gameWindow.gameState = 'Playing';
                gameWindow.score = 150;
                gameWindow.gameStartTime = Date.now() - 10000; // 10 seconds ago (well past grace period)
                gameWindow.gameWasPlayed = true;
                gameWindow.scoreSubmitted = false;
                gameWindow.pageLoadTime = Date.now() - 30000; // 30 seconds ago (well past grace period)
                
                log('2Ô∏è‚É£ Set up playing state with score 150');
                updateFlags();
                
                // End game and trigger modal check
                gameWindow.gameState = 'GameOver';
                gameWindow.updateUI();
                
                log('3Ô∏è‚É£ Game ended, updateUI() called');
                updateFlags();
                
                // Check if modal appeared
                setTimeout(() => {
                    const modal = gameWindow.document.getElementById('nameInputModal');
                    const isVisible = modal && !modal.classList.contains('hide');
                    
                    log(`üìä SINGLE MODAL RESULT: Modal visible = ${isVisible}`);
                    
                    if (isVisible) {
                        log('‚úÖ SUCCESS: Single modal test passed!');
                        updateStatus('Single modal test PASSED', 'success');
                    } else {
                        log('‚ùå FAILED: Single modal test failed');
                        log('üîç Debugging modal state...');
                        
                        if (modal) {
                            log(`   - Modal exists: YES`);
                            log(`   - Modal classes: ${modal.className}`);
                            log(`   - Modal display: ${gameWindow.getComputedStyle(modal).display}`);
                        } else {
                            log(`   - Modal exists: NO`);
                        }
                        
                        updateStatus('Single modal test FAILED', 'error');
                    }
                    
                    updateFlags();
                }, 500);
                
            } catch (error) {
                log(`‚ùå Error during single modal test: ${error.message}`);
                updateStatus(`Single modal test error: ${error.message}`, 'error');
            }
        }

        function testConsecutiveModals() {
            if (!gameWindow) {
                updateStatus('Game not loaded yet!', 'error');
                return;
            }

            log('\nüîÑ TESTING CONSECUTIVE MODALS:');
            updateStatus('Testing consecutive modals...', 'info');

            let testResults = [];

            function runGame(gameNumber, callback) {
                log(`\nüéÆ GAME ${gameNumber}:`);
                
                try {
                    // Reset to Ready state
                    gameWindow.gameState = 'Ready';
                    gameWindow.updateUI();
                    updateFlags();
                    log(`   1Ô∏è‚É£ Reset to Ready state`);
                    
                    // Set up game conditions with unique score
                    const score = 100 + (gameNumber * 50);
                    gameWindow.gameState = 'Playing';
                    gameWindow.score = score;
                    gameWindow.gameStartTime = Date.now() - 10000;
                    gameWindow.gameWasPlayed = true;
                    gameWindow.scoreSubmitted = false;
                    gameWindow.pageLoadTime = Date.now() - 60000; // Well past grace period
                    
                    log(`   2Ô∏è‚É£ Set up playing state with score ${score}`);
                    updateFlags();
                    
                    // End game
                    gameWindow.gameState = 'GameOver';
                    gameWindow.updateUI();
                    
                    log(`   3Ô∏è‚É£ Game ended, updateUI() called`);
                    updateFlags();
                    
                    // Check modal
                    setTimeout(() => {
                        const modal = gameWindow.document.getElementById('nameInputModal');
                        const isVisible = modal && !modal.classList.contains('hide');
                        
                        log(`   üìä GAME ${gameNumber} RESULT: Modal visible = ${isVisible}`);
                        testResults.push({ game: gameNumber, success: isVisible, score: score });
                        
                        if (isVisible) {
                            // Simulate submitting score to reset for next game
                            gameWindow.submitScore(`TestPlayer${gameNumber}`);
                            log(`   ‚úÖ Score submitted for game ${gameNumber}`);
                        }
                        
                        updateFlags();
                        
                        if (callback) callback();
                    }, 500);
                    
                } catch (error) {
                    log(`   ‚ùå Error in game ${gameNumber}: ${error.message}`);
                    testResults.push({ game: gameNumber, success: false, error: error.message });
                    if (callback) callback();
                }
            }

            // Run 3 consecutive games
            runGame(1, () => {
                setTimeout(() => {
                    runGame(2, () => {
                        setTimeout(() => {
                            runGame(3, () => {
                                // Show final results
                                setTimeout(() => {
                                    log('\nüìä CONSECUTIVE MODAL TEST RESULTS:');
                                    let successCount = 0;
                                    testResults.forEach(result => {
                                        if (result.success) {
                                            log(`   ‚úÖ Game ${result.game}: SUCCESS (score: ${result.score})`);
                                            successCount++;
                                        } else {
                                            log(`   ‚ùå Game ${result.game}: FAILED (score: ${result.score || 'N/A'})`);
                                            if (result.error) log(`      Error: ${result.error}`);
                                        }
                                    });
                                    
                                    log(`\nüéØ FINAL RESULT: ${successCount}/${testResults.length} games showed modal`);
                                    
                                    if (successCount === testResults.length) {
                                        updateStatus(`‚úÖ SUCCESS! All ${testResults.length} consecutive games showed the modal.`, 'success');
                                    } else if (successCount === 0) {
                                        updateStatus(`‚ùå FAILURE! No games showed the modal.`, 'error');
                                    } else {
                                        updateStatus(`‚ö†Ô∏è PARTIAL: ${successCount}/${testResults.length} games showed the modal.`, 'error');
                                    }
                                }, 500);
                            });
                        }, 1000);
                    });
                }, 1000);
            });
        }

        // Auto-update flags every second once game is loaded
        setInterval(() => {
            if (gameWindow) {
                updateFlags();
            }
        }, 1000);
    </script>
</body>
</html>
