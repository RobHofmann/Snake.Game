<!DOCTYPE html>
<html>
<head>
    <title>Consecutive Modal + Powerup Canvas Debug</title>
    <style>
        body {
            background-color: #1a0b2e;
            color: #4DEE5A;
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 2px solid #4DEE5A;
        }
        
        .game-frame {
            width: 100%;
            height: 800px;
            border: 2px solid #4DEE5A;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .debug-panel {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #555;
            font-family: monospace;
            font-size: 12px;
        }
        
        .test-button {
            background: #4DEE5A;
            color: #1a0b2e;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-weight: bold;
        }
        
        .test-button:hover {
            background: #39FF14;
        }
        
        .status-good {
            color: #4DEE5A;
            font-weight: bold;
        }
        
        .status-bad {
            color: #ff3131;
            font-weight: bold;
        }
        
        .status-warning {
            color: #ffaa00;
            font-weight: bold;
        }
        
        .console-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <h1>üêç Consecutive Modal + Powerup Canvas Debug Test</h1>
    
    <div class="test-section">
        <h2>üîç TEST PURPOSE</h2>
        <p>Analyze the relationship between powerup canvas visibility logic and modal functionality in consecutive games:</p>
        <ul>
            <li>Track powerup canvas visibility state during game transitions</li>
            <li>Monitor modal flag behavior during powerup panel updates</li>
            <li>Identify race conditions between powerup panel logic and modal display</li>
            <li>Test if powerup panel state affects input focus and modal interaction</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>üéÆ GAME TEST FRAME</h2>
        <iframe src="http://localhost:5263" class="game-frame" id="gameFrame"></iframe>
    </div>
    
    <div class="test-section">
        <h2>üìä POWERUP CANVAS STATE MONITOR</h2>
        <div class="debug-panel" id="powerupCanvasState">
            <div>Monitoring powerup canvas visibility...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üö© MODAL FLAGS TRACKER</h2>
        <div class="debug-panel" id="modalFlagsState">
            <div>Monitoring modal flags...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üîÑ GAME STATE TRANSITIONS</h2>
        <div class="debug-panel" id="gameStateTransitions">
            <div>Monitoring game state changes...</div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>üìù CONSOLE OUTPUT</h2>
        <div class="console-output" id="consoleOutput">
            Console messages will appear here...
        </div>
    </div>
    
    <div class="test-section">
        <h2>üß™ TEST CONTROLS</h2>
        <button class="test-button" onclick="startMonitoring()">üîç Start Monitoring</button>
        <button class="test-button" onclick="stopMonitoring()">‚èπÔ∏è Stop Monitoring</button>
        <button class="test-button" onclick="clearLogs()">üßπ Clear Logs</button>
        <button class="test-button" onclick="analyzeIssue()">üî¨ Analyze Issue</button>
    </div>

    <script>
        let monitoringInterval = null;
        let gameFrameWindow = null;
        let logCounter = 0;
        let previousStates = {
            powerupCanvasVisible: null,
            modalFlags: {},
            gameState: null
        };
        
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const consoleOutput = document.getElementById('consoleOutput');
            const color = level === 'error' ? '#ff3131' : level === 'warning' ? '#ffaa00' : '#4DEE5A';
            
            consoleOutput.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            logCounter++;
            if (logCounter > 200) {
                // Clear old logs to prevent memory issues
                const lines = consoleOutput.innerHTML.split('\n');
                consoleOutput.innerHTML = lines.slice(-100).join('\n');
                logCounter = 100;
            }
        }
        
        function startMonitoring() {
            if (monitoringInterval) return;
            
            log("üîç Starting powerup canvas and modal monitoring...");
            
            // Get reference to game frame
            const gameFrame = document.getElementById('gameFrame');
            gameFrameWindow = gameFrame.contentWindow;
            
            monitoringInterval = setInterval(() => {
                try {
                    monitorPowerupCanvasState();
                    monitorModalFlags();
                    monitorGameState();
                } catch (error) {
                    log(`‚ùå Monitoring error: ${error.message}`, 'error');
                }
            }, 100); // Check every 100ms
            
            log("‚úÖ Monitoring started successfully");
        }
        
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                log("‚èπÔ∏è Monitoring stopped");
            }
        }
        
        function clearLogs() {
            document.getElementById('consoleOutput').innerHTML = '';
            logCounter = 0;
            log("üßπ Logs cleared");
        }
        
        function monitorPowerupCanvasState() {
            if (!gameFrameWindow) return;
            
            try {
                const powerupCanvas = gameFrameWindow.document.getElementById('powerupCanvas');
                if (!powerupCanvas) return;
                
                const isVisible = !powerupCanvas.classList.contains('hide');
                const displayStyle = powerupCanvas.style.display;
                const computedDisplay = gameFrameWindow.getComputedStyle(powerupCanvas).display;
                
                const stateInfo = {
                    visible: isVisible,
                    displayStyle: displayStyle || 'default',
                    computedDisplay: computedDisplay,
                    hasHideClass: powerupCanvas.classList.contains('hide')
                };
                
                // Only log if state changed
                if (JSON.stringify(stateInfo) !== JSON.stringify(previousStates.powerupCanvasVisible)) {
                    log(`üé® Powerup Canvas State Changed: visible=${isVisible}, display=${computedDisplay}, hideClass=${stateInfo.hasHideClass}`, 'warning');
                    previousStates.powerupCanvasVisible = stateInfo;
                }
                
                // Update display
                document.getElementById('powerupCanvasState').innerHTML = `
                    <div><strong>Powerup Canvas State:</strong></div>
                    <div>Visible: <span class="${isVisible ? 'status-good' : 'status-bad'}">${isVisible}</span></div>
                    <div>Has 'hide' class: <span class="${stateInfo.hasHideClass ? 'status-bad' : 'status-good'}">${stateInfo.hasHideClass}</span></div>
                    <div>Display style: ${displayStyle || 'none'}</div>
                    <div>Computed display: ${computedDisplay}</div>
                `;
            } catch (error) {
                log(`‚ùå Error monitoring powerup canvas: ${error.message}`, 'error');
            }
        }
        
        function monitorModalFlags() {
            if (!gameFrameWindow) return;
            
            try {
                const flags = {
                    scoreSubmitted: gameFrameWindow.scoreSubmitted,
                    gameWasPlayed: gameFrameWindow.gameWasPlayed,
                    gameStartTime: gameFrameWindow.gameStartTime,
                    powerupPanelFrozen: gameFrameWindow.powerupPanelFrozen,
                    readyStateActive: gameFrameWindow.readyStateActive
                };
                
                // Only log if flags changed
                if (JSON.stringify(flags) !== JSON.stringify(previousStates.modalFlags)) {
                    log(`üö© Modal Flags Changed: scoreSubmitted=${flags.scoreSubmitted}, gameWasPlayed=${flags.gameWasPlayed}, gameStartTime=${flags.gameStartTime}, powerupPanelFrozen=${flags.powerupPanelFrozen}, readyStateActive=${flags.readyStateActive}`, 'warning');
                    previousStates.modalFlags = flags;
                }
                
                // Update display
                document.getElementById('modalFlagsState').innerHTML = `
                    <div><strong>Modal Control Flags:</strong></div>
                    <div>scoreSubmitted: <span class="${flags.scoreSubmitted ? 'status-bad' : 'status-good'}">${flags.scoreSubmitted}</span></div>
                    <div>gameWasPlayed: <span class="${flags.gameWasPlayed ? 'status-good' : 'status-warning'}">${flags.gameWasPlayed}</span></div>
                    <div>gameStartTime: <span class="${flags.gameStartTime > 0 ? 'status-good' : 'status-warning'}">${flags.gameStartTime}</span></div>
                    <div>powerupPanelFrozen: <span class="${flags.powerupPanelFrozen ? 'status-warning' : 'status-good'}">${flags.powerupPanelFrozen}</span></div>
                    <div>readyStateActive: <span class="${flags.readyStateActive ? 'status-good' : 'status-warning'}">${flags.readyStateActive}</span></div>
                `;
            } catch (error) {
                log(`‚ùå Error monitoring modal flags: ${error.message}`, 'error');
            }
        }
        
        function monitorGameState() {
            if (!gameFrameWindow) return;
            
            try {
                const gameState = gameFrameWindow.gameState;
                const score = gameFrameWindow.score;
                
                // Only log if game state changed
                if (gameState !== previousStates.gameState) {
                    log(`üéÆ Game State Changed: ${previousStates.gameState} ‚Üí ${gameState} (Score: ${score})`, 'info');
                    previousStates.gameState = gameState;
                }
                
                // Update display
                document.getElementById('gameStateTransitions').innerHTML = `
                    <div><strong>Current Game State:</strong></div>
                    <div>State: <span class="status-good">${gameState}</span></div>
                    <div>Score: <span class="status-good">${score}</span></div>
                    <div>Last transition: ${previousStates.gameState || 'None'} ‚Üí ${gameState}</div>
                `;
            } catch (error) {
                log(`‚ùå Error monitoring game state: ${error.message}`, 'error');
            }
        }
        
        function analyzeIssue() {
            log("üî¨ ANALYZING POTENTIAL ISSUES...", 'warning');
            
            if (!gameFrameWindow) {
                log("‚ùå Cannot analyze - no game frame access", 'error');
                return;
            }
            
            try {
                // Check for common problems
                const powerupCanvas = gameFrameWindow.document.getElementById('powerupCanvas');
                const nameInputModal = gameFrameWindow.document.getElementById('nameInputModal');
                
                // Issue 1: Powerup canvas visibility affecting modal
                if (powerupCanvas) {
                    const powerupCanvasVisible = !powerupCanvas.classList.contains('hide');
                    if (powerupCanvasVisible && gameFrameWindow.gameState === 'GameOver') {
                        log("‚ö†Ô∏è POTENTIAL ISSUE: Powerup canvas is visible during GameOver state", 'warning');
                        log("   This might interfere with modal focus or input handling", 'warning');
                    }
                }
                
                // Issue 2: Modal state
                if (nameInputModal) {
                    const modalVisible = !nameInputModal.classList.contains('hide');
                    const modalDisplay = gameFrameWindow.getComputedStyle(nameInputModal).display;
                    log(`üìã Modal visibility: visible=${modalVisible}, display=${modalDisplay}`);
                }
                
                // Issue 3: Flag consistency
                const flags = {
                    scoreSubmitted: gameFrameWindow.scoreSubmitted,
                    gameWasPlayed: gameFrameWindow.gameWasPlayed,
                    gameStartTime: gameFrameWindow.gameStartTime
                };
                
                if (flags.scoreSubmitted && gameFrameWindow.gameState === 'GameOver') {
                    log("‚ö†Ô∏è POTENTIAL ISSUE: scoreSubmitted is true during GameOver - modal may be blocked", 'warning');
                }
                
                if (!flags.gameWasPlayed && gameFrameWindow.score > 0) {
                    log("‚ö†Ô∏è POTENTIAL ISSUE: gameWasPlayed is false but score > 0", 'warning');
                }
                
                if (flags.gameStartTime <= 0 && gameFrameWindow.score > 0) {
                    log("‚ö†Ô∏è POTENTIAL ISSUE: gameStartTime is 0 but score > 0", 'warning');
                }
                
                log("‚úÖ Analysis complete", 'info');
                
            } catch (error) {
                log(`‚ùå Analysis error: ${error.message}`, 'error');
            }
        }
        
        // Auto-start monitoring when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                log("üöÄ Auto-starting monitoring...");
                startMonitoring();
            }, 2000);
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>
