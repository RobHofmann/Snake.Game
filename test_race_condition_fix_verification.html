<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game - Complete High Score Modal Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #000; color: #0f0; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; border-radius: 5px; }
        .success { background-color: rgba(0, 255, 0, 0.1); }
        .error { background-color: rgba(255, 0, 0, 0.1); color: #f00; }
        .info { background-color: rgba(0, 255, 255, 0.1); color: #0ff; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #0f0; color: #000; border: none; border-radius: 3px; }
        button:hover { background: #39ff14; }
        #console { background: #111; color: #0f0; padding: 15px; height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; border: 1px solid #0f0; }
        .game-frame { width: 100%; height: 600px; border: 1px solid #0f0; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .test-results { background: #111; border: 1px solid #0f0; padding: 10px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üêç Snake Game - High Score Modal Race Condition Fix Verification</h1>
        
        <div class="test-section info">
            <h2>üéØ Test Objective</h2>
            <p>Verify that the high score modal appears correctly after implementing the race condition fix in the updateUI() function.</p>
            <p><strong>Fix Details:</strong> Added 100ms delayed reset of gameStartTime and gameWasPlayed flags to prevent race condition between modal validation and flag reset.</p>
        </div>

        <div class="test-grid">
            <div class="test-section">
                <h3>üéÆ Game Instance</h3>
                <iframe id="game-frame" class="game-frame" src="/"></iframe>
            </div>
            
            <div class="test-section">
                <h3>üß™ Test Controls</h3>
                <button onclick="testDirectHighScore()">Test High Score (300)</button>
                <button onclick="testMediumScore()">Test Medium Score (150)</button>
                <button onclick="testLowScore()">Test Low Score (50)</button>
                <button onclick="testConsecutiveGames()">Test Consecutive Games</button>
                <button onclick="checkGameState()">Check Game State</button>
                <button onclick="clearConsole()">Clear Console</button>
                
                <div class="test-results">
                    <h4>Test Results:</h4>
                    <div id="test-results"></div>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìä Console Output</h3>
            <div id="console"></div>
        </div>
    </div>

    <script>
        let gameWindow = null;
        let testResults = [];
        const consoleDiv = document.getElementById('console');
        const resultsDiv = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0ff';
            consoleDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        function addTestResult(testName, success, details) {
            const result = { testName, success, details, timestamp: new Date().toLocaleTimeString() };
            testResults.push(result);
            
            const resultElement = document.createElement('div');
            resultElement.style.color = success ? '#0f0' : '#f00';
            resultElement.innerHTML = `
                <strong>${success ? '‚úÖ' : '‚ùå'} ${testName}</strong><br>
                ${details}<br>
                <small>${result.timestamp}</small>
            `;
            resultsDiv.appendChild(resultElement);
        }
        
        // Load game
        document.getElementById('game-frame').onload = function() {
            gameWindow = this.contentWindow;
            log('‚úÖ Game loaded successfully', 'success');
            
            // Wait for game to initialize
            setTimeout(() => {
                if (gameWindow.gameState !== undefined) {
                    log('üéÆ Game state initialized: ' + gameWindow.gameState, 'success');
                } else {
                    log('‚ö†Ô∏è Game state not yet available', 'warning');
                }
            }, 1000);
        };
        
        function checkGameState() {
            if (!gameWindow) {
                log('‚ùå Game not loaded', 'error');
                return;
            }
            
            try {
                log('üîç Current Game State:', 'info');
                log(`   gameState: ${gameWindow.gameState}`);
                log(`   score: ${gameWindow.score}`);
                log(`   gameStartTime: ${gameWindow.gameStartTime}`);
                log(`   gameWasPlayed: ${gameWindow.gameWasPlayed}`);
                log(`   scoreSubmitted: ${gameWindow.scoreSubmitted}`);
                log(`   readyStateActive: ${gameWindow.readyStateActive}`);
                
                const modal = gameWindow.document.getElementById('nameInputModal');
                const isModalVisible = modal && !modal.classList.contains('hide');
                log(`   modal visible: ${isModalVisible}`);
                
            } catch (error) {
                log(`‚ùå Error checking game state: ${error.message}`, 'error');
            }
        }
        
        async function simulateGameWithScore(targetScore, testName) {
            if (!gameWindow) {
                log('‚ùå Game not loaded', 'error');
                addTestResult(testName, false, 'Game not loaded');
                return;
            }
            
            try {
                log(`\nüéØ Starting ${testName} with target score ${targetScore}`, 'info');
                
                // Step 1: Reset to Ready state
                gameWindow.gameState = 'Ready';
                gameWindow.updateUI();
                log('   1Ô∏è‚É£ Reset to Ready state');
                
                // Step 2: Simulate starting a new game
                gameWindow.gameState = 'Playing';
                gameWindow.score = 0;
                gameWindow.gameStartTime = Date.now();
                gameWindow.gameWasPlayed = true;
                gameWindow.scoreSubmitted = false;
                gameWindow.pageLoadTime = Date.now() - 60000; // 1 minute ago
                window.readyStateActive = false; // Reset the Ready state flag
                
                log(`   2Ô∏è‚É£ Game started - flags set correctly`);
                log(`      gameStartTime: ${gameWindow.gameStartTime}`);
                log(`      gameWasPlayed: ${gameWindow.gameWasPlayed}`);
                log(`      scoreSubmitted: ${gameWindow.scoreSubmitted}`);
                
                // Step 3: Simulate game progression to target score
                gameWindow.score = targetScore;
                log(`   3Ô∏è‚É£ Score reached: ${targetScore}`);
                
                // Step 4: End the game
                gameWindow.gameState = 'GameOver';
                log(`   4Ô∏è‚É£ Game ended - triggering updateUI()`);
                
                // Check flags before updateUI call
                log(`   üìä Flags before updateUI: gameStartTime=${gameWindow.gameStartTime}, gameWasPlayed=${gameWindow.gameWasPlayed}, scoreSubmitted=${gameWindow.scoreSubmitted}`);
                
                gameWindow.updateUI();
                
                // Step 5: Check modal after a brief delay
                setTimeout(() => {
                    const modal = gameWindow.document.getElementById('nameInputModal');
                    const isModalVisible = modal && !modal.classList.contains('hide');
                    
                    log(`   üìä Flags after updateUI: gameStartTime=${gameWindow.gameStartTime}, gameWasPlayed=${gameWindow.gameWasPlayed}, scoreSubmitted=${gameWindow.scoreSubmitted}`);
                    log(`   üé≠ Modal visible: ${isModalVisible}`);
                    
                    const expectedModalVisible = targetScore >= 300;
                    const success = isModalVisible === expectedModalVisible;
                    
                    if (success) {
                        log(`   ‚úÖ ${testName} PASSED: Modal behavior correct for score ${targetScore}`, 'success');
                        addTestResult(testName, true, `Score: ${targetScore}, Modal: ${isModalVisible ? 'Shown' : 'Hidden'} (Expected: ${expectedModalVisible ? 'Shown' : 'Hidden'})`);
                    } else {
                        log(`   ‚ùå ${testName} FAILED: Modal behavior incorrect`, 'error');
                        log(`      Expected modal visible: ${expectedModalVisible}, Actual: ${isModalVisible}`, 'error');
                        addTestResult(testName, false, `Score: ${targetScore}, Modal: ${isModalVisible ? 'Shown' : 'Hidden'} (Expected: ${expectedModalVisible ? 'Shown' : 'Hidden'})`);
                    }
                    
                    // If modal is visible, dismiss it for next test
                    if (isModalVisible) {
                        gameWindow.submitScore('TestPlayer');
                        log(`   üîß Modal dismissed for next test`);
                    }
                }, 150); // Wait a bit longer than the flag reset delay
                
            } catch (error) {
                log(`‚ùå Error in ${testName}: ${error.message}`, 'error');
                addTestResult(testName, false, `Error: ${error.message}`);
            }
        }
        
        function testDirectHighScore() {
            simulateGameWithScore(300, 'High Score Test');
        }
        
        function testMediumScore() {
            simulateGameWithScore(150, 'Medium Score Test');
        }
        
        function testLowScore() {
            simulateGameWithScore(50, 'Low Score Test');
        }
        
        function testConsecutiveGames() {
            log('\nüîÑ Testing Consecutive Games...', 'info');
            
            // Test game 1 (high score)
            setTimeout(() => {
                simulateGameWithScore(320, 'Consecutive Game 1');
                
                // Test game 2 (medium score) after game 1
                setTimeout(() => {
                    simulateGameWithScore(180, 'Consecutive Game 2');
                    
                    // Test game 3 (low score) after game 2
                    setTimeout(() => {
                        simulateGameWithScore(40, 'Consecutive Game 3');
                        
                        setTimeout(() => {
                            log('\nüìä Consecutive Games Test Complete', 'info');
                            const consecutiveTests = testResults.filter(r => r.testName.startsWith('Consecutive Game'));
                            const allPassed = consecutiveTests.every(t => t.success);
                            
                            if (allPassed) {
                                log('‚úÖ All consecutive games passed - Race condition fix is working!', 'success');
                            } else {
                                log('‚ùå Some consecutive games failed - Race condition may still exist', 'error');
                            }
                        }, 200);
                    }, 1000);
                }, 1000);
            }, 500);
        }
        
        log('üöÄ Snake Game High Score Modal Test Ready');
        log('üéÆ Game will load in the frame above. Once loaded, use the test buttons to verify the race condition fix.');
        log('');
        log('üìã Expected Results:');
        log('‚Ä¢ Scores >= 300: Modal should appear');
        log('‚Ä¢ Scores < 300: Modal should NOT appear (auto-submit as Anonymous)');
        log('‚Ä¢ Consecutive games: Each should behave correctly regardless of previous games');
    </script>
</body>
</html>
