<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game - Final Consecutive Modal Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            margin-bottom: 20px;
        }
        .btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #005a9e;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.danger {
            background: #dc3545;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .log {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .game-container {
            margin: 20px 0;
            text-align: center;
        }
        #game-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #007acc;
            border-radius: 4px;
        }
        .test-summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .test-result {
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .result-pass { background: #d4edda; color: #155724; }
        .result-fail { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéØ Snake Game - Final Consecutive Modal Verification</h1>
        <p>This test verifies that the consecutive modal fix is working correctly. The modal should appear for all consecutive games that meet the high score criteria.</p>
        
        <div class="status info">
            <div id="status">Ready to test consecutive modal functionality</div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="loadGame()">üéÆ Load Game</button>
            <button class="btn success" onclick="testConsecutiveModals()">üîÑ Test Consecutive Modals</button>
            <button class="btn" onclick="analyzeRaceCondition()">üî¨ Analyze Race Condition Fix</button>
            <button class="btn" onclick="clearLog()">üßπ Clear Log</button>
        </div>
        
        <div class="test-summary" id="testSummary" style="display: none;">
            <h3>üìä Test Results Summary</h3>
            <div id="summaryContent"></div>
        </div>
        
        <div class="game-container">
            <iframe id="game-frame" src=""></iframe>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let gameWindow = null;
        let testResults = [];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#333';
            logDiv.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.parentElement.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function loadGame() {
            log('üéÆ Loading Snake Game...', 'info');
            updateStatus('Loading game...', 'info');
            
            const gameFrame = document.getElementById('game-frame');
            gameFrame.src = 'http://localhost:5263';
            
            gameFrame.onload = function() {
                try {
                    gameWindow = this.contentWindow;
                    log('‚úÖ Game loaded successfully!', 'success');
                    updateStatus('üéÆ Game loaded! Ready to test consecutive modals.', 'success');
                } catch (error) {
                    log(`‚ùå Error accessing game window: ${error.message}`, 'error');
                    updateStatus('Error loading game', 'error');
                }
            };
        }

        function testConsecutiveModals() {
            if (!gameWindow) {
                updateStatus('Game not loaded! Click "Load Game" first.', 'error');
                return;
            }

            log('üîÑ TESTING CONSECUTIVE MODAL FUNCTIONALITY', 'success');
            log('====================================');
            updateStatus('Testing consecutive modals...', 'info');
            
            testResults = [];
            
            // Test 5 consecutive games
            runConsecutiveTest(1, () => {
                setTimeout(() => {
                    runConsecutiveTest(2, () => {
                        setTimeout(() => {
                            runConsecutiveTest(3, () => {
                                setTimeout(() => {
                                    runConsecutiveTest(4, () => {
                                        setTimeout(() => {
                                            runConsecutiveTest(5, () => {
                                                showTestSummary();
                                            });
                                        }, 1000);
                                    });
                                }, 1000);
                            });
                        }, 1000);
                    });
                }, 1000);
            });
        }

        function runConsecutiveTest(gameNumber, callback) {
            log(`\nüéØ Testing Game ${gameNumber}:`);
            
            try {
                // Step 1: Reset to Ready state
                gameWindow.gameState = 'Ready';
                gameWindow.updateUI();
                log(`   1Ô∏è‚É£ Reset to Ready state (readyStateActive: ${gameWindow.readyStateActive})`);
                
                // Step 2: Set up game with qualifying score
                const score = 50 + (gameNumber * 25); // Progressive scores: 75, 100, 125, 150, 175
                gameWindow.gameState = 'Playing';
                gameWindow.score = score;
                gameWindow.gameStartTime = Date.now() - 10000; // Game started 10 seconds ago
                gameWindow.gameWasPlayed = true;
                gameWindow.scoreSubmitted = false;
                gameWindow.pageLoadTime = Date.now() - 60000; // Page loaded 60 seconds ago
                
                log(`   2Ô∏è‚É£ Set up playing state with score ${score}`);
                
                // Step 3: End game and trigger modal check
                gameWindow.gameState = 'GameOver';
                gameWindow.updateUI();
                log(`   3Ô∏è‚É£ Game ended, updateUI() called`);
                
                // Step 4: Check if modal appeared
                setTimeout(() => {
                    const modal = gameWindow.document.getElementById('nameInputModal');
                    const isVisible = modal && !modal.classList.contains('hide');
                    
                    const result = {
                        game: gameNumber,
                        score: score,
                        modalVisible: isVisible,
                        success: isVisible,
                        timestamp: new Date().toLocaleTimeString()
                    };
                    
                    testResults.push(result);
                    
                    if (isVisible) {
                        log(`   ‚úÖ GAME ${gameNumber} PASSED: Modal appeared for score ${score}`, 'success');
                        // Simulate submitting score to prepare for next game
                        gameWindow.submitScore(`TestPlayer${gameNumber}`);
                    } else {
                        log(`   ‚ùå GAME ${gameNumber} FAILED: Modal did not appear for score ${score}`, 'error');
                    }
                    
                    if (callback) callback();
                }, 500);
                
            } catch (error) {
                log(`   ‚ùå ERROR in Game ${gameNumber}: ${error.message}`, 'error');
                testResults.push({
                    game: gameNumber,
                    score: 0,
                    modalVisible: false,
                    success: false,
                    error: error.message,
                    timestamp: new Date().toLocaleTimeString()
                });
                if (callback) callback();
            }
        }

        function showTestSummary() {
            log('\nüìä CONSECUTIVE MODAL TEST COMPLETE!');
            log('====================================');
            
            const passCount = testResults.filter(r => r.success).length;
            const totalCount = testResults.length;
            const passRate = ((passCount / totalCount) * 100).toFixed(1);
            
            log(`üìà RESULTS: ${passCount}/${totalCount} tests passed (${passRate}%)`);
            
            if (passCount === totalCount) {
                log('üéâ ALL TESTS PASSED! Consecutive modal fix is working correctly!', 'success');
                updateStatus(`‚úÖ All ${totalCount} consecutive modal tests PASSED!`, 'success');
            } else {
                log('‚ö†Ô∏è Some tests failed. The consecutive modal issue may still exist.', 'error');
                updateStatus(`‚ùå Only ${passCount}/${totalCount} tests passed. Issue still exists.`, 'error');
            }
            
            // Show detailed summary
            const summaryDiv = document.getElementById('testSummary');
            const summaryContent = document.getElementById('summaryContent');
            
            let summaryHTML = `<p><strong>Overall Result:</strong> ${passCount}/${totalCount} tests passed (${passRate}%)</p>`;
            summaryHTML += '<div>';
            
            testResults.forEach(result => {
                const statusClass = result.success ? 'result-pass' : 'result-fail';
                const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                summaryHTML += `<div class="test-result ${statusClass}">
                    ${statusIcon} Game ${result.game}: Score ${result.score} - ${result.success ? 'PASSED' : 'FAILED'}
                    ${result.error ? ` (Error: ${result.error})` : ''}
                </div>`;
            });
            
            summaryHTML += '</div>';
            summaryContent.innerHTML = summaryHTML;
            summaryDiv.style.display = 'block';
        }

        function analyzeRaceCondition() {
            if (!gameWindow) {
                updateStatus('Game not loaded! Click "Load Game" first.', 'error');
                return;
            }

            log('üî¨ ANALYZING RACE CONDITION FIX', 'info');
            log('====================================');
            updateStatus('Analyzing race condition fix...', 'info');

            try {
                log('üìã Race Condition Analysis:');
                log('‚Ä¢ PROBLEM: updateUI() was resetting flags every time gameState === "Ready"');
                log('‚Ä¢ SOLUTION: Flags only reset on FIRST entry to Ready state');
                log('‚Ä¢ IMPLEMENTATION: Added readyStateActive flag to track state transitions');
                
                log('\nüîç Current readyStateActive status:');
                log(`‚Ä¢ readyStateActive: ${gameWindow.readyStateActive || false}`);
                
                log('\nüß™ Testing flag reset behavior:');
                
                // Test: First entry to Ready state should reset flags
                gameWindow.gameState = 'Playing';
                gameWindow.readyStateActive = false;
                gameWindow.scoreSubmitted = true; // Set to true to test reset
                gameWindow.gameStartTime = 12345;
                gameWindow.gameWasPlayed = true;
                
                log('‚Ä¢ Before Ready transition: scoreSubmitted=true, gameStartTime=12345, gameWasPlayed=true');
                
                gameWindow.gameState = 'Ready';
                gameWindow.updateUI();
                
                log(`‚Ä¢ After Ready transition: scoreSubmitted=${gameWindow.scoreSubmitted}, gameStartTime=${gameWindow.gameStartTime}, gameWasPlayed=${gameWindow.gameWasPlayed}`);
                log(`‚Ä¢ readyStateActive: ${gameWindow.readyStateActive}`);
                
                // Test: Subsequent updateUI calls should NOT reset flags
                gameWindow.scoreSubmitted = true; // Set flag again
                gameWindow.gameStartTime = 99999;
                gameWindow.gameWasPlayed = true;
                
                log('‚Ä¢ Set flags again: scoreSubmitted=true, gameStartTime=99999, gameWasPlayed=true');
                
                gameWindow.updateUI(); // Should NOT reset flags
                
                log(`‚Ä¢ After second updateUI: scoreSubmitted=${gameWindow.scoreSubmitted}, gameStartTime=${gameWindow.gameStartTime}, gameWasPlayed=${gameWindow.gameWasPlayed}`);
                
                if (gameWindow.scoreSubmitted === true && gameWindow.gameStartTime === 99999) {
                    log('‚úÖ RACE CONDITION FIX WORKING: Flags preserved on subsequent updateUI calls!', 'success');
                    updateStatus('‚úÖ Race condition fix is working correctly!', 'success');
                } else {
                    log('‚ùå RACE CONDITION FIX FAILED: Flags were reset on subsequent updateUI calls', 'error');
                    updateStatus('‚ùå Race condition fix is not working', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error analyzing race condition: ${error.message}`, 'error');
                updateStatus('Error analyzing race condition', 'error');
            }
        }

        // Initial message
        log('üéØ Final Consecutive Modal Verification Ready', 'success');
        log('Click "Load Game" to begin testing the consecutive modal fix...');
    </script>
</body>
</html>
